<html>
  <head>
    <title>Tak Online</title>
    <style>
      body { margin: 0; }
      canvas { width: 100%; height: 100% }
    </style>
  </head>
  <body>
    <script src="/js/three.min.js"></script>
    <script src="/js/jquery.min.js"></script>
    <script>
      var scene = new THREE.Scene();
      var pieces = 5;
      var aspect = window.innerWidth / window.innerHeight;
      var camera = new THREE.OrthographicCamera( -1, (2 * pieces - 1) * aspect, 2 * pieces - 1, -1, 1, 1000);
      camera.position.x = 2 - pieces;
      camera.position.y = -2 * (pieces + 1);
      camera.position.z = pieces * 2;
      camera.rotation.x = Math.PI / 4;

      var renderer = new THREE.WebGLRenderer();
      renderer.setSize( window.innerWidth, window.innerHeight );
      document.body.appendChild( renderer.domElement );

      // Create board out of thin squares
      for (var i = 0; i < pieces; i++) {
        for (var j = 0; j < pieces; j++) {
          var box = new THREE.BoxGeometry(2, 2, 0.01, 32);
          if ((i + j) % 2 == 0) {
            var material = new THREE.MeshBasicMaterial({ color: 0xbdbdbd });
          } else {
            var material = new THREE.MeshBasicMaterial({ color: 0x2a2a2a });
          }

          var block = new THREE.Mesh(box, material);
          block.position.x = i * 2;
          block.position.y = j * 2;
          scene.add(block);
        }
      }

      var materials = [ 1,
        new THREE.MeshBasicMaterial( { color: 0x000000, shading: THREE.FlatShading, wireframe: true, transparent: true } )
      ];

      function place_piece(piece, i, j, k) {
        if (piece.owner == "One") {
          materials[0] = new THREE.MeshBasicMaterial( { color: 0xff0000 } );
        } else {
          materials[0] = new THREE.MeshBasicMaterial( { color: 0xffffff } );
        }

        if (piece.stone == "Capstone") {
          var mesh = new THREE.SphereGeometry(0.5, 32, 32, 0, Math.PI, 0, Math.PI );
          var stone = new THREE.Mesh(mesh, materials[0]);
        } else {
          var mesh = new THREE.BoxGeometry(1, 1, 0.25);
          var stone = new THREE.SceneUtils.createMultiMaterialObject(mesh, materials);
          if (piece.stone == "Standing") {
            stone.rotation.x = Math.PI/2;
            stone.rotation.y = -Math.PI/4;
            stone.position.z = 0.5;
          } else if (piece.stone = "Flat") {
            stone.position.z = 0.15;
          }
        }

        stone.position.x = 2 * j;
        stone.position.y = 2 * i;
        stone.position.z += 0.3 * k;
        scene.add(stone);
      }

      // Place stones based on current URL
      var url = window.location.href.split("/");
      function refresh() {
        $.get("/json/" + url[url.length - 1], function(data, status) {
          var grid = data.board.grid;
          for (var i = 0; i < grid.length; i++) {
            for (var j = 0; j < grid.length; j++) {
              var cell = grid[i][j].pieces;
              for (var k = 0; k < cell.length; k++) {
                place_piece(cell[k], i, j, k);
              }
            }
          }
        });
        setTimeout(refresh, 1000);
      }
      refresh();

      var render = function () {
        requestAnimationFrame( render );
        renderer.render(scene, camera);
      };
      render();

      function onDocumentMouseDown(event) {
        event.preventDefault();
        var mouse = new THREE.Vector2();
        mouse.x = (event.clientX / renderer.domElement.clientWidth) * 2 - 1;
        mouse.y = -(event.clientY / renderer.domElement.clientHeight) * 2 + 1;

        var raycaster = new THREE.Raycaster();
        raycaster.setFromCamera(mouse, camera);
        var intersects = raycaster.intersectObjects(scene.children);

        if ( intersects.length > 0 ) {
          var xs = "abcdefgh";
          var ys = "12345678";
          var x = intersects[0].object.position.x / 2 + 1;
          var y = intersects[0].object.position.y / 2 + 1;

          var postData = {"turn": xs[x] + ys[y] + "F1"};
          $.post("/game/" + url[url.length - 1], postData, function(data, textStatus, jqXHR) {
            console.log(data);
            console.log(textStatus);
          });
          console.log("/game/" + url[url.length - 1]);
          console.log(xs[x] + ys[y] + "F1");
        }
      }
      document.addEventListener('mousedown', onDocumentMouseDown, false);
    </script>
  </body>
</html>
